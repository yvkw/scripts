<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle do Canal YouTube</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">

  <h1 class="text-3xl font-bold mb-6">Painel de Controle</h1>

  <!-- Botão para abrir configurações -->
  <button id="toggleConfig" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition mb-4">Configurar Canal</button>

  <!-- Configurações -->
  <div id="configPanel" class="hidden bg-white shadow-lg rounded-2xl p-6 w-full max-w-3xl mb-8">
    <h2 class="text-xl font-semibold mb-4">Configurações</h2>
    <form id="configForm" class="space-y-4">
      <div>
        <label class="block text-gray-700 font-medium">Backlog de Vídeos</label>
        <input type="number" min="0" value="0" id="backlog" class="w-full border rounded-lg p-2">
        <p id="backlogCounter" class="mt-2 text-blue-600 font-semibold">Backlog atual: 0 vídeos</p>
      </div>

      <div>
        <button type="button" id="openDatePicker" class="bg-gray-600 text-white px-3 py-2 rounded-lg hover:bg-gray-700 transition">Selecionar dias no calendário</button>
        <div id="selectedDays" class="mt-3 flex flex-wrap gap-2"></div>
      </div>

      <button type="button" id="saveConfig" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition">Salvar Configurações</button>
    </form>
  </div>

  <!-- Mensagem de erro backlog -->
  <p id="backlogError" class="hidden text-red-600 font-bold mb-4">⚠️ Você não tem vídeos no backlog para selecionar dias!</p>

  <!-- Calendário -->
  <div class="bg-white shadow-lg rounded-2xl p-6 w-full max-w-4xl">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold" id="calendarTitle">Calendário de Postagens</h2>
      <div class="flex gap-2">
        <button id="prevMonth" class="bg-gray-200 px-3 py-1 rounded-lg hover:bg-gray-300 transition">◀</button>
        <button id="nextMonth" class="bg-gray-200 px-3 py-1 rounded-lg hover:bg-gray-300 transition">▶</button>
      </div>
    </div>

    <!-- Cabeçalho dos dias da semana -->
    <div class="grid grid-cols-7 gap-2 text-center font-bold mb-2">
      <div>Dom</div>
      <div>Seg</div>
      <div>Ter</div>
      <div>Qua</div>
      <div>Qui</div>
      <div>Sex</div>
      <div>Sáb</div>
    </div>

    <div id="calendar" class="grid grid-cols-7 gap-2 text-center"></div>
  </div>

  <!-- Backup e Reset -->
  <div class="mt-6 flex gap-4">
    <button id="exportBackup" class="bg-purple-600 text-white px-4 py-2 rounded-lg shadow hover:bg-purple-700 transition">Exportar Backup</button>
    <input type="file" id="importBackup" class="hidden" accept="application/json">
    <button id="importBackupBtn" class="bg-orange-600 text-white px-4 py-2 rounded-lg shadow hover:bg-orange-700 transition">Importar Backup</button>
    <button id="clearAll" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 transition">Limpar Tudo</button>
  </div>

  <!-- Modal calendário -->
  <div id="datePickerModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">
    <div class="bg-white p-6 rounded-2xl shadow-lg w-96">
      <h2 class="text-lg font-semibold mb-4">Selecione os dias</h2>
      <div class="flex justify-between mb-2">
        <button id="prevMonthModal" class="bg-gray-200 px-3 py-1 rounded-lg hover:bg-gray-300 transition">◀</button>
        <h3 id="modalMonthTitle" class="font-semibold"></h3>
        <button id="nextMonthModal" class="bg-gray-200 px-3 py-1 rounded-lg hover:bg-gray-300 transition">▶</button>
      </div>
      <div id="modalCalendar" class="grid grid-cols-7 gap-2 text-center"></div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="closeModal" class="bg-gray-400 text-white px-3 py-1 rounded-lg hover:bg-gray-500 transition">Fechar</button>
        <button id="confirmDates" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    const toggleConfigBtn = document.getElementById('toggleConfig');
    const configPanel = document.getElementById('configPanel');
    const saveConfigBtn = document.getElementById('saveConfig');
    const backlogInput = document.getElementById('backlog');
    const backlogCounter = document.getElementById('backlogCounter');
    const backlogError = document.getElementById('backlogError');
    const selectedDaysDiv = document.getElementById('selectedDays');

    const calendarDiv = document.getElementById('calendar');
    const calendarTitle = document.getElementById('calendarTitle');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');

    const exportBtn = document.getElementById('exportBackup');
    const importBtn = document.getElementById('importBackupBtn');
    const importInput = document.getElementById('importBackup');
    const clearBtn = document.getElementById('clearAll');

    const modal = document.getElementById('datePickerModal');
    const openDatePicker = document.getElementById('openDatePicker');
    const closeModal = document.getElementById('closeModal');
    const confirmDates = document.getElementById('confirmDates');
    const modalCalendar = document.getElementById('modalCalendar');
    const modalMonthTitle = document.getElementById('modalMonthTitle');
    const prevMonthModal = document.getElementById('prevMonthModal');
    const nextMonthModal = document.getElementById('nextMonthModal');

    let currentMonth = new Date();
    let modalMonth = new Date();
    let selectedDates = [];
    let backlog = 0;
    let dayStatuses = {}; // salvar status Post/Env/Ok

    // ----- Funções -----
    function saveState() {
      const state = { selectedDates, backlog, dayStatuses };
      localStorage.setItem("ytChannelState", JSON.stringify(state));
    }

    function loadState() {
      const state = JSON.parse(localStorage.getItem("ytChannelState"));
      if (state) {
        selectedDates = state.selectedDates || [];
        backlog = state.backlog || 0;
        dayStatuses = state.dayStatuses || {};
        backlogInput.value = backlog;
        backlogCounter.innerText = `Backlog atual: ${backlog} vídeos`;
        updateSelectedDays();
      }
    }

    function renderCalendar() {
      calendarDiv.innerHTML = '';
      let today = new Date();

      let startDate = new Date(currentMonth);
      startDate.setDate(1);

      let startDay = startDate.getDay();
      startDate.setDate(startDate.getDate() - startDay);

      for (let i = 0; i < 42; i++) {
        let day = new Date(startDate);
        day.setDate(startDate.getDate() + i);

        const dayDiv = document.createElement('div');
        dayDiv.className = "p-3 border rounded-lg min-h-[60px] flex flex-col items-center justify-between";
        dayDiv.innerHTML = `<span>${day.getDate()}</span>`;

        if (day.toDateString() === today.toDateString()) {
          dayDiv.classList.add("bg-yellow-200", "border-yellow-500");
          dayDiv.innerHTML += `<span class='text-xs font-bold text-yellow-800'>Hoje</span>`;
        }

        let iso = day.toISOString().split('T')[0];
        if (selectedDates.includes(iso)) {
          const btn = document.createElement('button');
          btn.innerText = dayStatuses[iso] || "Marcado";

          // se a data já passou e estava marcada, vira OK automático
          if (new Date(iso) < today) {
            btn.innerText = "Ok";
            btn.className = "mt-1 px-2 py-1 text-xs rounded text-white bg-green-600";
            dayStatuses[iso] = "Ok";
            saveState();
          } else {
            btn.className = `mt-1 px-2 py-1 text-xs rounded text-white ${btn.innerText === "Env" ? "bg-blue-500" : "bg-red-500"}`;
            btn.addEventListener('click', () => {
              if (backlog <= 0 && btn.innerText === "Post") {
                backlogError.classList.remove('hidden');
                return;
              }
              backlogError.classList.add('hidden');
              if (btn.innerText === "Post") {
                btn.innerText = "Env";
                btn.classList.remove("bg-red-500");
                btn.classList.add("bg-blue-500");
                backlog--;
              } else if (btn.innerText === "Env") {
                btn.innerText = "Post";
                btn.classList.remove("bg-blue-500");
                btn.classList.add("bg-red-500");
                backlog++;
              }
              backlogCounter.innerText = `Backlog atual: ${backlog} vídeos`;
              backlogInput.value = backlog;
              dayStatuses[iso] = btn.innerText;
              saveState();
            });
          }

          dayDiv.appendChild(btn);
        }

        calendarDiv.appendChild(dayDiv);
      }

      let options = { month: 'long', year: 'numeric' };
      calendarTitle.innerText = `Calendário de Postagens - ${currentMonth.toLocaleDateString('pt-BR', options)}`;
    }

    function renderModalCalendar() {
      modalCalendar.innerHTML = '';
      let startDate = new Date(modalMonth);
      startDate.setDate(1);
      let startDay = startDate.getDay();
      startDate.setDate(startDate.getDate() - startDay);

      for (let i = 0; i < 42; i++) {
        let day = new Date(startDate);
        day.setDate(startDate.getDate() + i);
        const iso = day.toISOString().split('T')[0];

        const dayDiv = document.createElement('div');
        dayDiv.className = `p-2 border rounded-lg cursor-pointer hover:bg-blue-100 ${selectedDates.includes(iso) ? 'bg-blue-300' : ''}`;
        dayDiv.innerText = day.getDate();

        dayDiv.addEventListener('click', () => {
          if (backlog <= 0) {
            backlogError.classList.remove('hidden');
            return;
          }
          backlogError.classList.add('hidden');

          if (selectedDates.includes(iso)) {
            selectedDates = selectedDates.filter(d => d !== iso);
            delete dayStatuses[iso];
          } else {
            selectedDates.push(iso);
            dayStatuses[iso] = "Post";
          }
          renderModalCalendar();
          updateSelectedDays();
          saveState();
        });

        modalCalendar.appendChild(dayDiv);
      }

      let options = { month: 'long', year: 'numeric' };
      modalMonthTitle.innerText = modalMonth.toLocaleDateString('pt-BR', options);
    }

    function updateSelectedDays() {
      selectedDaysDiv.innerHTML = '';
      selectedDates.forEach(date => {
        const span = document.createElement('span');
        span.className = "bg-blue-500 text-white px-2 py-1 rounded-full text-sm";
        span.innerText = date;
        selectedDaysDiv.appendChild(span);
      });
    }

    // ----- Eventos -----
    toggleConfigBtn.addEventListener('click', () => {
      configPanel.classList.toggle('hidden');
    });

    saveConfigBtn.addEventListener('click', () => {
      backlog = parseInt(backlogInput.value) || 0;
      backlogCounter.innerText = `Backlog atual: ${backlog} vídeos`;
      saveState();
      configPanel.classList.add('hidden');
    });

    prevMonthBtn.addEventListener('click', () => {
      currentMonth.setMonth(currentMonth.getMonth() - 1);
      renderCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
      currentMonth.setMonth(currentMonth.getMonth() + 1);
      renderCalendar();
    });

    // Modal
    openDatePicker.addEventListener('click', () => {
      if (backlog <= 0) {
        backlogError.classList.remove('hidden');
        return;
      }
      backlogError.classList.add('hidden');
      modal.classList.remove('hidden');
      renderModalCalendar();
    });
    closeModal.addEventListener('click', () => modal.classList.add('hidden'));
    confirmDates.addEventListener('click', () => {
      modal.classList.add('hidden');
      renderCalendar();
      saveState();
    });
    prevMonthModal.addEventListener('click', () => {
      modalMonth.setMonth(modalMonth.getMonth() - 1);
      renderModalCalendar();
    });
    nextMonthModal.addEventListener('click', () => {
      modalMonth.setMonth(modalMonth.getMonth() + 1);
      renderModalCalendar();
    });

    // Backup
    exportBtn.addEventListener('click', () => {
      const data = JSON.stringify({ selectedDates, backlog, dayStatuses });
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "backup.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', () => importInput.click());
    importInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const data = JSON.parse(ev.target.result);
        selectedDates = data.selectedDates || [];
        backlog = data.backlog || 0;
        dayStatuses = data.dayStatuses || {};
        backlogInput.value = backlog;
        backlogCounter.innerText = `Backlog atual: ${backlog} vídeos`;
        updateSelectedDays();
        renderCalendar();
        saveState();
      };
      reader.readAsText(file);
    });

    clearBtn.addEventListener('click', () => {
      if (confirm("Tem certeza que deseja limpar tudo?")) {
        selectedDates = [];
        backlog = 0;
        dayStatuses = {};
        backlogInput.value = 0;
        backlogCounter.innerText = `Backlog atual: 0 vídeos`;
        selectedDaysDiv.innerHTML = '';
        backlogError.classList.add('hidden');
        renderCalendar();
        localStorage.removeItem("ytChannelState");
      }
    });

    // ----- Inicialização -----
    loadState();
    renderCalendar();
  </script>

</body>
</html>

